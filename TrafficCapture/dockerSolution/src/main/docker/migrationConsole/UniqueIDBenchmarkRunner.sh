#!/bin/bash

# Usage: ./UniqueIDBenchmarkRunner.sh [replacement_string] [-- args for runTestBenchmark.sh]

# This script will make the required edits to each workloads files to update the index name generated by
# the workload, then run OpensearchBenchmark, then restore the workload files to the original state
# so they can be used for a different run.


SEARCH_STRING="testID"
REPLACEMENT_STRING=${1:-''}

OSB_TESTFILE="./runTestBenchmarks.sh"
FOLDERS=("geonames" "nyc_taxis" "nested" "http_logs")

for FOLDER in "${FOLDERS[@]}"; do
    WORKLOAD_FILE="${FOLDER}/workload.json"
    DEFAULT_FILE="${FOLDER}/test_procedures/default.json"
    WORKLOAD_BACKUP="${WORKLOAD_FILE}.backup"
    DEFAULT_BACKUP="${DEFAULT_FILE}.backup"

    cp "$WORKLOAD_FILE" "$WORKLOAD_BACKUP"
    cp "$DEFAULT_FILE" "$DEFAULT_BACKUP"


    if [ -n "$SEARCH_STRING" ]; then
        sed -i'' "s/$SEARCH_STRING/$REPLACEMENT_STRING/g" "$WORKLOAD_FILE"
        sed -i'' "s/$SEARCH_STRING/$REPLACEMENT_STRING/g" "$DEFAULT_FILE"
    fi
done

shift
# Above shift statement is required so that args for runTestBenchmark can be provided if needed.
bash "$OSB_TESTFILE" "$@"

for FOLDER in "${FOLDERS[@]}"; do
    WORKLOAD_FILE="${FOLDER}/workload.json"
    DEFAULT_FILE="${FOLDER}/test_procedures/default.json"
    WORKLOAD_BACKUP="${WORKLOAD_FILE}.backup"
    DEFAULT_BACKUP="${DEFAULT_FILE}.backup"

    mv "$WORKLOAD_BACKUP" "$WORKLOAD_FILE"
    mv "$DEFAULT_BACKUP" "$DEFAULT_FILE"
done

echo "Files have been restored to their original state."
